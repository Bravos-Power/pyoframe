import time
import importlib
import itertools
import os
import subprocess
from snakemake.utils import available_cpu_count

configfile: "config.yaml"

include: "src/energy_planning/build_dataset.smk"

wildcard_constraints:
    problem="[a-z_]+",
    library="[a-z]+",
    solver="[a-z]+",
    size="\d+"

rule all:
    input:
        expand("results/{problem}/combined_results.png", problem=config["problems"])
        
rule profile:
    threads: available_cpu_count()
    output:
        "results/{problem}/{library}_{solver}_{size}.prof"
    shell:
        # --native doesn't work for rust calls back to Python wh
        "py-spy record --native -s -t -f speedscope --rate 20 -o results/{wildcards.problem}/{wildcards.library}_{wildcards.solver}_{wildcards.size}.prof -- python src/benchmark_utils/run_benchmark.py {wildcards.problem} --library {wildcards.library} --solver {wildcards.solver} --size {wildcards.size}"

rule mem_profile:
    threads: available_cpu_count()
    output:
        "results/{problem}/{library}_{solver}_{size}_memray.html"
    shell:
        """
        memray run --trace-python-allocators --follow-fork --native --aggregate -o results/{wildcards.problem}/{wildcards.library}_{wildcards.solver}_{wildcards.size}_memray.bin src/benchmark_utils/run_benchmark.py {wildcards.problem} --library {wildcards.library} --solver {wildcards.solver} --size {wildcards.size}
        memray flamegraph -o results/{wildcards.problem}/{wildcards.library}_{wildcards.solver}_{wildcards.size}_memray.html results/{wildcards.problem}/{wildcards.library}_{wildcards.solver}_{wildcards.size}_memray.bin
        """

